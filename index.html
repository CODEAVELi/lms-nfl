<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LMS NFL â€“ Live Tracker</title>

  <!-- Pixel fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tecmo: {
              navy: '#0b1021',
              blue: '#0d6cf2',
              green: '#3cbc0d',
              gold: '#f8b800',
              red: '#e40058',
              white: '#f5f7ff',
              gray: '#9aa2b1',
              field: '#1c7c2a',
              shadow: '#05070f'
            }
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            pixelmono: ['"VT323"', 'ui-monospace', 'SFMono-Regular', 'monospace']
          }
        }
      }
    };
  </script>
  <meta name="color-scheme" content="light dark" />
  <style>
    html,body { height:100%; }
    :root {
      --tecmo-navy: #0b1021;
      --tecmo-blue: #0d6cf2;
      --tecmo-green: #3cbc0d;
      --tecmo-gold: #f8b800;
      --tecmo-red: #e40058;
      --tecmo-white: #f5f7ff;
      --tecmo-shadow: #05070f;
      --tecmo-outline: #0b1021;
    }
    body.tecmo {
      background-color: var(--tecmo-navy);
      color: var(--tecmo-white);
    }
    /* Subtle pixel grid + blue wash */
    .grid-bg {
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,0.04) 0, rgba(255,255,255,0.04) 1px, transparent 1px, transparent 8px),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.04) 0, rgba(255,255,255,0.04) 1px, transparent 1px, transparent 8px),
        linear-gradient(180deg, rgba(13,108,242,0.08), transparent);
    }
    .pixel-font { font-family: "Press Start 2P", ui-sans-serif, system-ui, sans-serif; letter-spacing: 0.5px; }
    .pixel-mono { font-family: "VT323", ui-monospace, SFMono-Regular, monospace; font-size: 1.05rem; }
    .sprite { image-rendering: pixelated; image-rendering: crisp-edges; }
    .team-logo { width: 20px; height: 16px; position: relative; display: inline-flex; align-items: center; justify-content: center; }
    .team-logo img { max-width: 100%; max-height: 100%; image-rendering: pixelated; }
    .team-chip { width: 20px; height: 16px; border: 2px solid var(--tecmo-white); background: #0e142a; color: var(--tecmo-white); box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15); display: inline-flex; align-items: center; justify-content: center; font-family: "Press Start 2P", ui-sans-serif, system-ui, sans-serif; font-size: 9px; line-height: 1; }
    .panel-8bit {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.06));
      border: 2px solid var(--tecmo-white);
      box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15);
    }
    .btn-8bit {
      border: 2px solid var(--tecmo-white);
      background-color: var(--tecmo-blue);
      color: var(--tecmo-white);
      box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 -2px 0 0 var(--tecmo-shadow);
      transition: transform 80ms, filter 80ms;
    }
    .btn-8bit:hover { filter: brightness(1.05); }
    .btn-8bit:active { transform: translateY(1px); box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 1px 0 0 var(--tecmo-shadow); }
    .btn-8bit.secondary {
      background-color: transparent;
      color: var(--tecmo-white);
      border-color: var(--tecmo-white);
    }
    .btn-8bit.warn { background-color: var(--tecmo-gold); color: #1b1400; }
    .btn-8bit.danger { background-color: var(--tecmo-red); }
    .pill-8bit {
      border: 2px solid var(--tecmo-white);
      padding: 6px 10px;
      background: transparent;
      color: var(--tecmo-white);
      box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15);
      text-transform: uppercase;
      font-size: 11px;
    }
    .pill-8bit.active { background: var(--tecmo-green); color: #021304; }
    .badge-8bit {
      display: inline-block;
      padding: 2px 6px;
      border: 2px solid var(--tecmo-white);
      box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .badge-pending { background: #1c233e; color: #b8c0ff; }
    .badge-win { background: var(--tecmo-green); color: #05250b; }
    .badge-lose { background: var(--tecmo-red); color: #ffe6ef; }
    .badge-push { background: var(--tecmo-gold); color: #1a1400; }
    .table-8bit th, .table-8bit td { border-top: 2px solid rgba(255,255,255,0.12); }
    .table-8bit thead th { background: rgba(255,255,255,0.06); border-bottom: 2px solid rgba(255,255,255,0.2); }
    .table-row-win { background: rgba(60,188,13,0.08); }
    .table-row-lose { background: rgba(228,0,88,0.08); }
    .table-row-push { background: rgba(248,184,0,0.08); }
    /* Scoreboard */
    .scoreboard {
      border: 3px solid var(--tecmo-white);
      background: linear-gradient(180deg, #0a0f1f, #121a36);
      box-shadow: 0 0 0 3px var(--tecmo-shadow), inset 0 0 0 2px rgba(255,255,255,0.12);
      color: var(--tecmo-white);
    }
    .kickoff { display: flex; align-items: center; gap: 6px; }
    .bulb {
      width: 12px; height: 12px; border: 2px solid var(--tecmo-white);
      border-radius: 50%;
      background: #1c233e;
      box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15);
      opacity: .4;
    }
    .is-live .bulb { animation: chase 1.1s linear infinite; opacity: .9; }
    .is-live .bulb:nth-child(1) { animation-delay: 0s; background: var(--tecmo-gold); }
    .is-live .bulb:nth-child(2) { animation-delay: .12s; background: var(--tecmo-gold); }
    .is-live .bulb:nth-child(3) { animation-delay: .24s; background: var(--tecmo-gold); }
    .is-live .bulb:nth-child(4) { animation-delay: .36s; background: var(--tecmo-gold); }
    .is-live .bulb:nth-child(5) { animation-delay: .48s; background: var(--tecmo-gold); }
    @keyframes chase {
      0%, 100% { filter: brightness(.9) drop-shadow(0 0 0 transparent); transform: translateY(0); }
      50% { filter: brightness(1.3) drop-shadow(0 0 6px rgba(248,184,0,.6)); transform: translateY(-1px); }
    }
    .progress-8bit { height: 14px; border: 2px solid var(--tecmo-white); box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15); }
    .progress-8bit .bar { height: 100%; background: linear-gradient(90deg, var(--tecmo-red), #f95c96); }
    /* Inputs */
    .input-8bit, .select-8bit, .textarea-8bit {
      background: #0e142a; color: var(--tecmo-white);
      border: 2px solid var(--tecmo-white);
      box-shadow: 0 0 0 2px var(--tecmo-shadow), inset 0 0 0 1px rgba(255,255,255,0.15);
    }
    .helper-8bit { color: #9aa2b1; font-size: 11px; }
    @media (max-width: 480px) {
      .pixel-font { font-size: 11px; }
      .scoreboard .pixel-font { font-size: 10px; }
    }
  </style>
</head>
<body class="min-h-screen tecmo grid-bg">
  <div id="root"></div>

  <!-- React + Babel (so we can paste JSX without a build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef, useCallback } = React;

    const RESULT = { Pending: "Pending", Win: "Win", Lose: "Lose", Push: "Push" };
    const STORAGE_KEY = "lmsNFL.weeks.v3";
    const AUTO_REFRESH_KEY = "lmsNFL.autoRefresh";
    const AUTO_REFRESH_INTERVAL_MS = 60_000;

    const SEASON_TYPES = [
      { value: 1, label: "Preseason" },
      { value: 2, label: "Regular Season" },
      { value: 3, label: "Postseason" },
    ];

    const TEAM_CATALOG = [
      { abbr: "ARI", names: ["Cardinals", "Arizona Cardinals", "Arizona", "Zona"] },
      { abbr: "ATL", names: ["Falcons", "Atlanta Falcons"] },
      { abbr: "BAL", names: ["Ravens", "Baltimore Ravens"] },
      { abbr: "BUF", names: ["Bills", "Buffalo Bills"] },
      { abbr: "CAR", names: ["Panthers", "Carolina Panthers"] },
      { abbr: "CHI", names: ["Bears", "Chicago Bears"] },
      { abbr: "CIN", names: ["Bengals", "Cincinnati Bengals"] },
      { abbr: "CLE", names: ["Browns", "Cleveland Browns"] },
      { abbr: "DAL", names: ["Cowboys", "Dallas Cowboys"] },
      { abbr: "DEN", names: ["Broncos", "Denver Broncos"] },
      { abbr: "DET", names: ["Lions", "Detroit Lions"] },
      { abbr: "GB", names: ["Packers", "Green Bay Packers", "Pack"] },
      { abbr: "HOU", names: ["Texans", "Houston Texans"] },
      { abbr: "IND", names: ["Colts", "Indianapolis Colts"] },
      { abbr: "JAX", names: ["Jaguars", "Jacksonville Jaguars", "Jags"] },
      { abbr: "KC", names: ["Chiefs", "Kansas City Chiefs"] },
      { abbr: "LV", names: ["Raiders", "Las Vegas Raiders", "Oakland Raiders"] },
      { abbr: "LAC", names: ["Chargers", "Los Angeles Chargers", "LA Chargers", "San Diego Chargers", "Bolts"] },
      { abbr: "LAR", names: ["Rams", "Los Angeles Rams", "LA Rams", "St Louis Rams"] },
      { abbr: "MIA", names: ["Dolphins", "Miami Dolphins", "Fins"] },
      { abbr: "MIN", names: ["Vikings", "Minnesota Vikings", "Vikes"] },
      { abbr: "NE", names: ["Patriots", "New England Patriots", "Pats"] },
      { abbr: "NO", names: ["Saints", "New Orleans Saints", "Nola"] },
      { abbr: "NYG", names: ["Giants", "New York Giants", "NY Giants", "G-Men"] },
      { abbr: "NYJ", names: ["Jets", "New York Jets", "NY Jets"] },
      { abbr: "PHI", names: ["Eagles", "Philadelphia Eagles", "Philly"] },
      { abbr: "PIT", names: ["Steelers", "Pittsburgh Steelers"] },
      { abbr: "SF", names: ["49ers", "San Francisco 49ers", "Niners", "Forty Niners", "SF 49ers"] },
      { abbr: "SEA", names: ["Seahawks", "Seattle Seahawks", "Hawks"] },
      { abbr: "TB", names: ["Buccaneers", "Tampa Bay Buccaneers", "Bucs"] },
      { abbr: "TEN", names: ["Titans", "Tennessee Titans"] },
      { abbr: "WAS", names: ["Commanders", "Washington Commanders", "Washington Football Team", "Football Team", "Redskins", "Washington"] },
    ];

    const TEAM_ALIASES = TEAM_CATALOG.reduce((acc, { abbr, names }) => {
      const uppercaseAbbr = abbr.toUpperCase();
      const canonical = uppercaseAbbr.replace(/[^A-Z0-9]/g, "");
      acc[uppercaseAbbr] = uppercaseAbbr;
      acc[canonical] = uppercaseAbbr;
      names.forEach((name) => {
        if (!name) return;
        const key = name.toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (key) acc[key] = uppercaseAbbr;
      });
      return acc;
    }, {});

    const fmt = (n) => Number.isFinite(n) ? n.toLocaleString() : "0";

    function getDefaultSeason() {
      const now = new Date();
      return now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
    }

    function normalizedResult(value) {
      const next = typeof value === "string" ? value.trim() : "";
      if (!Object.values(RESULT).includes(next)) {
        return RESULT.Pending;
      }
      return next === RESULT.Push ? RESULT.Lose : next;
    }

    function normalizeTeam(team = {}) {
      const count = Number(team.count);
      return {
        team: (team.team || "").trim(),
        count: Number.isFinite(count) ? count : 0,
        result: normalizedResult(team.result),
        live: team.live || null,
      };
    }

    function normalizeWeek(week = {}) {
      const declared = Number(week.declaredGrandTotal);
      return {
        name: week.name || "Week",
        preOut: Array.isArray(week.preOut)
          ? week.preOut.map((p) => ({
              label: (p.label || "Pre-Out").trim(),
              count: Number.isFinite(Number(p.count)) ? Number(p.count) : 0,
            }))
          : [],
        teams: Array.isArray(week.teams) ? week.teams.map(normalizeTeam) : [],
        declaredGrandTotal: Number.isFinite(declared) ? declared : 0,
        season: Number.isFinite(Number(week.season)) ? Number(week.season) : getDefaultSeason(),
        weekNumber: Number.isFinite(Number(week.weekNumber)) ? Number(week.weekNumber) : 1,
        seasonType: Number.isFinite(Number(week.seasonType)) ? Number(week.seasonType) : 2,
        lastFetchedUtc: week.lastFetchedUtc || null,
        lastWarnings: Array.isArray(week.lastWarnings) ? week.lastWarnings : [],
        lastSource: week.lastSource || null,
      };
    }

    const DEFAULT_WEEK8 = normalizeWeek({
      name: "Week 8",
      season: getDefaultSeason(),
      seasonType: 2,
      weekNumber: 8,
      preOut: [
        { label: "Late Pick â€“ Out", count: 7 },
        { label: "No Pick â€“ Out", count: 3 },
        { label: "Chiefs â€“ Twice Out", count: 1 },
      ],
      teams: [
        { team: "Colts", count: 345, result: RESULT.Pending },
        { team: "Falcons", count: 205, result: RESULT.Pending },
        { team: "Bengals", count: 143, result: RESULT.Pending },
        { team: "Eagles", count: 74, result: RESULT.Pending },
        { team: "Patriots", count: 71, result: RESULT.Pending },
        { team: "Chiefs", count: 68, result: RESULT.Pending },
        { team: "Bills", count: 22, result: RESULT.Pending },
        { team: "Bucs", count: 13, result: RESULT.Pending },
        { team: "Ravens", count: 7, result: RESULT.Pending },
        { team: "Chargers", count: 3, result: RESULT.Pending },
      ],
      declaredGrandTotal: 962,
    });

    function loadInitialWeeks() {
      if (typeof window !== "undefined") {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed) && parsed.length) {
              return parsed.map(normalizeWeek);
            }
          }
        } catch (_) {
          console.warn("Could not load stored LMS weeks");
        }
      }
      return [DEFAULT_WEEK8];
    }

    function aliasForTeam(name) {
      const key = (name || "").toUpperCase().replace(/[^A-Z0-9]/g, "");
      return TEAM_ALIASES[key] || null;
    }

    function buildScoreIndex(events = []) {
      const index = {};
      (events || []).forEach((event) => {
        const competition = event.competitions?.[0];
        if (!competition) return;
        const statusType = competition.status?.type || {};
        const statusText = statusType.shortDetail || statusType.detail || "";
        const competitors = competition.competitors || [];
        competitors.forEach((competitor) => {
          const opponent = competitors.find((c) => c.id !== competitor.id);
          const abbr = competitor?.team?.abbreviation;
          if (!abbr) return;
          index[abbr.toUpperCase()] = {
            competitor,
            opponent,
            status: statusType,
            statusText,
            date: competition.date,
            eventId: event.id,
          };
        });
      });
      return index;
    }

    function formatGameTime(iso) {
      if (!iso) return "";
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return "";
      return dt.toLocaleString([], { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" });
    }

    function finalResultFromScores(usScore, themScore) {
      if (!Number.isFinite(usScore) || !Number.isFinite(themScore)) return RESULT.Pending;
      if (usScore > themScore) return RESULT.Win;
      return RESULT.Lose;
    }

    function runSanityChecks() {
      if (typeof console === "undefined") return;
      const checks = [
        ["Alias: Chiefs -> KC", aliasForTeam("Chiefs") === "KC"],
        ["Alias: 49ers -> SF", aliasForTeam("49ers") === "SF"],
        ["Alias: LA Chargers -> LAC", aliasForTeam("LA Chargers") === "LAC"],
        ["Tie resolves to loss", finalResultFromScores(21, 21) === RESULT.Lose],
      ];
      if (console.groupCollapsed) console.groupCollapsed("LMS NFL validation");
      checks.forEach(([label, pass]) => {
        console[pass ? "log" : "warn"](`${pass ? "[OK]" : "[WARN]"} ${label}`);
      });
      if (console.groupEnd) console.groupEnd();
    }

    runSanityChecks();

    function useAnimatedNumber(value, duration = 600) {
      const [display, setDisplay] = useState(value);
      useEffect(() => {
        const from = display, to = value, start = performance.now();
        let raf;
        const tick = (now) => {
          const t = Math.min(1, (now - start) / duration);
          const eased = 1 - Math.pow(1 - t, 3);
          setDisplay(Math.round(from + (to - from) * eased));
          if (t < 1) raf = requestAnimationFrame(tick);
        };
        raf = requestAnimationFrame(tick);
        return () => cancelAnimationFrame(raf);
      }, [value]);
      return display;
    }

    // Team logo component:
    // - Attempts to load /assets/logos/ABBR.svg (preferred) and falls back to showing a pixel chip with the team abbreviation.
    // - To use logos: drop SVG files into /assets/logos (e.g., /assets/logos/KC.svg). PNGs also supported by changing extension.
    function TeamIcon({ teamName }) {
      const abbr = aliasForTeam(teamName) || "";
      const [loaded, setLoaded] = React.useState(false);
      const src = abbr ? `assets/logos/${abbr}.svg` : "";

      return (
        <span className="team-logo" aria-label={abbr || "team"}>
          {!loaded && <span className="team-chip">{abbr || "??"}</span>}
          {src && (
            <img
              src={src}
              alt=""
              aria-hidden="true"
              onLoad={() => setLoaded(true)}
              onError={() => setLoaded(false)}
              style={{ display: loaded ? "block" : "none" }}
            />
          )}
        </span>
      );
    }

    const StatCard = ({ title, value, sub }) => (
      <div className="panel-8bit p-4">
        <div className="pixel-font text-[10px] text-tecmo-white/80 uppercase">{title}</div>
        <div className="mt-2 pixel-mono text-2xl">{fmt(value)}</div>
        {sub !== undefined && <div className="mt-1 helper-8bit">{sub}</div>}
      </div>
    );

    const Pill = ({ active, children, onClick }) => (
      <button onClick={onClick} className={`pill-8bit ${active ? "active" : ""}`}>
        {children}
      </button>
    );

    const ResultBadge = ({ result }) => {
      const map = {
        [RESULT.Pending]: "badge-pending",
        [RESULT.Win]: "badge-win",
        [RESULT.Lose]: "badge-lose",
        [RESULT.Push]: "badge-push",
      };
      return <span className={`badge-8bit ${map[result]}`}>{result}</span>;
    };

    function App() {
      const [weeks, setWeeks] = useState(loadInitialWeeks);
      const [selectedIndex, setSelectedIndex] = useState(0);
      const [syncing, setSyncing] = useState(false);
      const [syncNotice, setSyncNotice] = useState(null);
      const noticeTimeoutRef = useRef(null);

      const [autoRefresh, setAutoRefresh] = useState(() => {
        if (typeof window === "undefined") return true;
        const stored = localStorage.getItem(AUTO_REFRESH_KEY);
        if (stored === null) return true;
        return stored === "true";
      });

      const week = weeks[selectedIndex] || weeks[0] || DEFAULT_WEEK8;

      useEffect(() => {
        if (typeof window === "undefined") return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(weeks));
      }, [weeks]);

      useEffect(() => {
        if (typeof window === "undefined") return;
        localStorage.setItem(AUTO_REFRESH_KEY, autoRefresh ? "true" : "false");
      }, [autoRefresh]);

      useEffect(() => {
        if (selectedIndex > weeks.length - 1) {
          setSelectedIndex(Math.max(0, weeks.length - 1));
        }
      }, [weeks.length, selectedIndex]);

      const clearNotice = useCallback(() => {
        if (noticeTimeoutRef.current) {
          clearTimeout(noticeTimeoutRef.current);
          noticeTimeoutRef.current = null;
        }
      }, []);

      const pushNotice = useCallback((notice) => {
        clearNotice();
        setSyncNotice(notice);
        if (notice && notice.persist !== true) {
          noticeTimeoutRef.current = setTimeout(() => setSyncNotice(null), 6000);
        }
      }, [clearNotice]);

      useEffect(() => () => clearNotice(), [clearNotice]);

      const fetchScores = useCallback(async ({ silent = false } = {}) => {
        const currentWeek = weeks[selectedIndex];
        if (!currentWeek) return;

        const season = currentWeek.season || getDefaultSeason();
        const seasonType = currentWeek.seasonType || 2;
        const weekNumber = currentWeek.weekNumber || 1;

        if (!silent) {
          setSyncing(true);
        }

        try {
          const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?week=${weekNumber}&seasontype=${seasonType}&dates=${season}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`ESPN responded with status ${response.status}`);
          const data = await response.json();
          const index = buildScoreIndex(data.events || []);
          const warningsSet = new Set();
          let finalsApplied = 0;

          setWeeks((prev) =>
            prev.map((w, i) => {
              if (i !== selectedIndex) return w;
              const updatedTeams = (w.teams || []).map((team) => {
                const alias = aliasForTeam(team.team);
                const info = alias ? index[alias] : null;
                if (!info) {
                  if (team.team) warningsSet.add(`No live data for "${team.team}" â€“ check spelling or week.`);
                  return { ...team, live: null };
                }

                const opponent = info.opponent;
                const status = info.status || {};
                const state = (status.state || "").toLowerCase();
                const completed = Boolean(status.completed || state === "post");
                const usScore = Number(info.competitor?.score);
                const themScore = Number(opponent?.score);

                let result = team.result;
                if (completed && Number.isFinite(usScore) && Number.isFinite(themScore)) {
                  result = finalResultFromScores(usScore, themScore);
                  if (result !== RESULT.Pending) finalsApplied += 1;
                } else if (!completed && (result === RESULT.Win || result === RESULT.Lose)) {
                  // keep manual override
                } else {
                  result = RESULT.Pending;
                }

                return {
                  ...team,
                  result,
                  live: {
                    opponent: opponent?.team?.shortDisplayName || opponent?.team?.displayName || "",
                    opponentAbbr: opponent?.team?.abbreviation || "",
                    teamScore: Number.isFinite(usScore) ? usScore : null,
                    opponentScore: Number.isFinite(themScore) ? themScore : null,
                    state,
                    statusText: info.statusText,
                    kickoff: info.date,
                    homeAway: info.competitor?.homeAway,
                    completed,
                  },
                };
              });

              return {
                ...w,
                teams: updatedTeams,
                lastFetchedUtc: new Date().toISOString(),
                lastWarnings: Array.from(warningsSet),
                lastSource: "espn",
              };
            })
          );

          if (!silent) {
            const warnings = Array.from(warningsSet);
            const type = warnings.length ? "warn" : "success";
            const base = `Synced ESPN scores for Week ${weekNumber}${finalsApplied ? ` â€“ ${finalsApplied} finals applied` : ""}`;
            const text = warnings.length
              ? `${base}. ${warnings.length} pick${warnings.length === 1 ? "" : "s"} need manual review.`
              : base;
            pushNotice({ type, text });
          }
        } catch (error) {
          pushNotice({ type: "error", text: `Live score sync failed: ${error.message}` });
        } finally {
          if (!silent) {
            setSyncing(false);
          }
        }
      }, [weeks, selectedIndex, pushNotice]);

      useEffect(() => {
        if (!autoRefresh) return;
        fetchScores({ silent: true });
        const id = setInterval(() => fetchScores({ silent: true }), AUTO_REFRESH_INTERVAL_MS);
        return () => clearInterval(id);
      }, [autoRefresh, fetchScores]);

      useEffect(() => {
        if (autoRefresh) {
          fetchScores({ silent: true });
        }
      }, [selectedIndex, autoRefresh, fetchScores]);

      const sums = useMemo(() => {
        if (!week) {
          return { picksTotal: 0, preOutTotal: 0, losers: 0, eliminated: 0, survivors: 0, pct: 0, grandTotal: 0 };
        }
        const teams = Array.isArray(week.teams) ? week.teams : [];
        const preOut = Array.isArray(week.preOut) ? week.preOut : [];
        const picksTotal = teams.reduce((a, t) => a + (Number.isFinite(Number(t.count)) ? Number(t.count) : 0), 0);
        const preOutTotal = preOut.reduce((a, p) => a + (Number.isFinite(Number(p.count)) ? Number(p.count) : 0), 0);
        const losers = teams
          .filter((t) => t.result === RESULT.Lose || t.result === RESULT.Push)
          .reduce((a, t) => a + (Number.isFinite(Number(t.count)) ? Number(t.count) : 0), 0);
        const eliminated = preOutTotal + losers;
        const declared = Number(week.declaredGrandTotal);
        const grandTotal = Number.isFinite(declared) && declared > 0 ? declared : picksTotal + preOutTotal;
        const survivors = Math.max(0, grandTotal - eliminated);
        const pct = grandTotal > 0 ? (eliminated / grandTotal) * 100 : 0;
        return { picksTotal, preOutTotal, losers, eliminated, survivors, pct, grandTotal };
      }, [week]);

      const animElim = useAnimatedNumber(sums.eliminated);
      const animSurv = useAnimatedNumber(sums.survivors);

      const setTeamResult = (teamName, result) => {
        const nextResult = normalizedResult(result);
        setWeeks((prev) =>
          prev.map((w, i) =>
            i !== selectedIndex
              ? w
              : {
                  ...w,
                  teams: (w.teams || []).map((t) => (t.team === teamName ? { ...t, result: nextResult } : t)),
                }
          )
        );
      };

      const addWeek = (name = `Week ${weeks.length + 1}`) => {
        const nextWeek = normalizeWeek({
          name,
          preOut: [],
          teams: [],
          declaredGrandTotal: 0,
          season: getDefaultSeason(),
          seasonType: 2,
          weekNumber: weeks.length + 1,
        });
        setWeeks((prev) => [...prev, nextWeek]);
        setSelectedIndex(weeks.length);
      };

      const parseAndLoad = (text) => {
        const parsed = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean)
          .map((line) => {
            const [teamRaw, countRaw] = line.split(",");
            const team = (teamRaw || "").trim();
            const count = Number(countRaw);
            return normalizeTeam({ team, count: Number.isFinite(count) ? count : 0, result: RESULT.Pending, live: null });
          });
        setWeeks((prev) =>
          prev.map((w, i) => (i !== selectedIndex ? w : { ...w, teams: parsed }))
        );
      };

      const exportJSON = () => {
        const blob = new Blob([JSON.stringify(weeks, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "lms_weeks.json";
        a.click();
        URL.revokeObjectURL(url);
      };

      const importJSON = (file) => {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (Array.isArray(parsed)) {
              setWeeks(parsed.map(normalizeWeek));
              setSelectedIndex(0);
              pushNotice({ type: "success", text: "Weeks import complete." });
            }
          } catch {
            alert("Invalid JSON");
          }
        };
        reader.readAsText(file);
      };

      const renderScore = (team) => {
        const live = team.live;
        if (!live) return "â€”";
        if (!Number.isFinite(live.teamScore) || !Number.isFinite(live.opponentScore)) return "â€”";
        return `${live.teamScore} â€“ ${live.opponentScore}`;
      };

      const renderGameLine = (team) => {
        const live = team.live;
        if (!live) return "No live data";
        const vsAt = live.homeAway === "home" ? "vs" : "@";
        const opponent = live.opponent || live.opponentAbbr || "TBD";
        const statusText = live.statusText || (live.state === "pre" ? formatGameTime(live.kickoff) : "In progress");
        return (
          <div>
            <div className="font-medium">{`${vsAt} ${opponent}`}</div>
            <div className="text-[11px] text-tecmo-white/70">{statusText}</div>
          </div>
        );
      };

      const hasLiveGames = useMemo(() => {
        return (week?.teams || []).some((t) => t.live && t.live.state !== "pre" && !t.live.completed);
      }, [week]);

      const seasonTypeLabel = useMemo(() => {
        switch (week?.seasonType) {
          case 1: return "Preseason";
          case 3: return "Postseason";
          default: return "Regular";
        }
      }, [week?.seasonType]);

      return (
        <div className="mx-auto max-w-7xl px-4 sm:px-6 py-6">
          {/* Scoreboard Header */}
          <div className={`scoreboard rounded-md p-3 sm:p-4 mb-6 ${hasLiveGames ? "is-live" : ""}`}>
            <div className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="kickoff" aria-label={hasLiveGames ? "Kickoff lights on" : "Kickoff lights off"}>
                  <span className="bulb"></span>
                  <span className="bulb"></span>
                  <span className="bulb"></span>
                  <span className="bulb"></span>
                  <span className="bulb"></span>
                </div>
                <div className="pixel-font text-tecmo-gold text-[10px] sm:text-xs uppercase tracking-wider">LMS NFL</div>
              </div>
              <div className="text-center flex-1">
                <div className="pixel-font text-[10px] sm:text-xs">
                  Week {week.weekNumber} â€¢ {seasonTypeLabel} {week.season}
                </div>
                <div className="pixel-mono text-tecmo-gold text-lg sm:text-2xl">{week.name}</div>
              </div>
              <div className="text-right">
                <div className="pixel-font text-[10px] sm:text-xs">Last Sync</div>
                <div className="pixel-mono">{week.lastFetchedUtc ? new Date(week.lastFetchedUtc).toLocaleTimeString() : "â€”"}</div>
              </div>
            </div>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3">
              <div className="panel-8bit p-2 text-center">
                <div className="pixel-font text-[10px] uppercase">Survivors</div>
                <div className="pixel-mono text-tecmo-green text-lg sm:text-xl">{fmt(animSurv)}</div>
              </div>
              <div className="panel-8bit p-2 text-center">
                <div className="pixel-font text-[10px] uppercase">Eliminated</div>
                <div className="pixel-mono text-tecmo-red text-lg sm:text-xl">{fmt(animElim)}</div>
              </div>
              <div className="panel-8bit p-2 text-center">
                <div className="pixel-font text-[10px] uppercase">Grand Total</div>
                <div className="pixel-mono text-lg sm:text-xl">{fmt(sums.grandTotal)}</div>
              </div>
              <div className="panel-8bit p-2 text-center">
                <div className="pixel-font text-[10px] uppercase">Auto Refresh</div>
                <div className="pixel-mono">{autoRefresh ? "ON" : "OFF"}</div>
              </div>
            </div>
          </div>

          {/* Header + week tabs */}
          <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
            <div>
              <h1 className="pixel-font text-tecmo-gold text-xl md:text-2xl">Last Man Standing â€“ NFL</h1>
              <p className="helper-8bit mt-1">Live elimination tracker with one-click ESPN score sync.</p>
            </div>
            <div className="flex flex-wrap gap-2">
              {weeks.map((w, i) => (
                <Pill key={i} active={i === selectedIndex} onClick={() => setSelectedIndex(i)}>
                  {w.name}
                </Pill>
              ))}
              <button
                onClick={() => addWeek()}
                className="btn-8bit secondary px-3 py-1.5 text-xs"
              >
                + Add Week
              </button>
            </div>
          </div>

          {/* Quick stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <StatCard title="Grand Total" value={sums.grandTotal} sub="Entries at week lock" />
            <StatCard title="Pre-Eliminated" value={sums.preOutTotal} sub="No pick â€¢ Double-Out" />
            <StatCard title="Eliminated (Live)" value={animElim} sub={`${fmt(sums.losers)} from losses/pushes`} />
            <StatCard title="Survivors" value={animSurv} sub={`${(100 - sums.pct).toFixed(1)}% remaining`} />
          </div>

          {/* Progress */}
          <div className="mt-4">
            <div className="progress-8bit overflow-hidden">
              <div className="bar" style={{ width: `${Math.min(100, sums.pct).toFixed(2)}%` }}></div>
            </div>
            <div className="helper-8bit mt-1">{sums.pct.toFixed(1)}% eliminated</div>
          </div>

          {/* Sync notice */}
          {syncNotice && (
            <div
              className={`mt-6 panel-8bit px-4 py-3 text-sm ${
                syncNotice.type === "error"
                  ? "bg-[rgba(228,0,88,0.15)]"
                  : syncNotice.type === "warn"
                  ? "bg-[rgba(248,184,0,0.15)]"
                  : "bg-[rgba(60,188,13,0.15)]"
              }`}
            >
              {syncNotice.text}
            </div>
          )}

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
            <div className="lg:col-span-2">
              <div className="panel-8bit rounded-md overflow-hidden">
                <div className="px-5 py-4 border-b border-white/20 flex items-center justify-between">
                  <h2 className="pixel-font text-sm">Picks ({week.name})</h2>
                  <div className="helper-8bit">Sync scores or override manually.</div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm table-8bit">
                    <thead>
                      <tr className="text-left">
                        <th className="px-4 py-3">Team</th>
                        <th className="px-4 py-3">Picks</th>
                        <th className="px-4 py-3">Result</th>
                        <th className="px-4 py-3">Score</th>
                        <th className="px-4 py-3">Game Status</th>
                        <th className="px-4 py-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(week.teams || []).map((t, idx) => (
                        <tr
                          key={t.team + idx}
                          className={`${
                            t.result === RESULT.Lose
                              ? "table-row-lose"
                              : t.result === RESULT.Win
                              ? "table-row-win"
                              : t.result === RESULT.Push
                              ? "table-row-push"
                              : ""
                          }`}
                        >
                          <td className="px-4 py-3 font-medium">
                            <div className="flex items-center gap-2">
                              <TeamIcon teamName={t.team} />
                              <span>{t.team}</span>
                            </div>
                          </td>
                          <td className="px-4 py-3 tabular-nums">{fmt(Number(t.count) || 0)}</td>
                          <td className="px-4 py-3"><ResultBadge result={t.result} /></td>
                          <td className="px-4 py-3 tabular-nums">{renderScore(t)}</td>
                          <td className="px-4 py-3">{renderGameLine(t)}</td>
                          <td className="px-4 py-3">
                            <div className="flex flex-nowrap gap-2 whitespace-nowrap">
                              {[RESULT.Win, RESULT.Lose, RESULT.Push, RESULT.Pending].map((r) => {
                                const label = r === RESULT.Push ? "Push (Lose)" : r;
                                const title = r === RESULT.Push ? "Push counts as a loss" : undefined;
                                const isActive = r === t.result;
                                return (
                                  <button
                                    key={r}
                                    onClick={() => setTeamResult(t.team, r)}
                                    title={title}
                                    className={`${isActive ? "btn-8bit" : "btn-8bit secondary"} px-2.5 py-1 text-[11px]`}
                                  >
                                    {label}
                                  </button>
                                );
                              })}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="px-5 py-4 border-t border-white/20">
                  <h3 className="pixel-font text-xs mb-2 uppercase">Already Out</h3>
                  <ul className="space-y-1 text-sm">
                    {(week.preOut || []).map((p, i) => (
                      <li key={i} className="flex items-center justify-between">
                        <span className="text-tecmo-white/80">{p.label}</span>
                        <span className="font-medium tabular-nums">{fmt(Number(p.count) || 0)}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>

            <div className="space-y-6">
              <div className="panel-8bit p-5 rounded-md">
                <h3 className="pixel-font text-sm uppercase">Manage Weeks & Picks</h3>
                <div className="mt-3 space-y-3 text-sm">
                  <label className="block">
                    <span className="helper-8bit">Rename current week</span>
                    <input
                      className="input-8bit mt-1 w-full px-3 py-2"
                      value={week.name}
                      onChange={(e) => {
                        const value = e.target.value;
                        setWeeks((prev) =>
                          prev.map((w, i) => (i === selectedIndex ? { ...w, name: value } : w))
                        );
                      }}
                    />
                  </label>

                  <div className="grid grid-cols-2 gap-2">
                    <button
                      onClick={() => addWeek(`Week ${weeks.length + 1}`)}
                      className="btn-8bit secondary px-3 py-2"
                    >
                      + New Week
                    </button>
                    <button
                      onClick={exportJSON}
                      className="btn-8bit secondary px-3 py-2"
                    >
                      Export JSON
                    </button>
                  </div>

                  <label className="block">
                    <span className="helper-8bit">Import JSON (export format)</span>
                    <input
                      type="file"
                      accept="application/json"
                      className="mt-1 w-full text-xs"
                      onChange={(e) => e.target.files?.[0] && importJSON(e.target.files[0])}
                    />
                  </label>

                  <label className="block">
                    <span className="helper-8bit">Paste teams (Team,Count per line)</span>
                    <textarea
                      className="textarea-8bit mt-1 w-full min-h-[120px] px-3 py-2"
                      placeholder={"Patriots,210\nChiefs,463"}
                      onBlur={(e) => {
                        if (e.target.value.trim()) {
                          parseAndLoad(e.target.value);
                          e.target.value = "";
                        }
                      }}
                    ></textarea>
                    <div className="helper-8bit mt-1">Tip: switch to a future week, paste new picks, and sync.</div>
                  </label>

                  <label className="block">
                    <span className="helper-8bit">Grand Total (optional â€“ defaults to picks + pre-out)</span>
                    <input
                      type="number"
                      className="input-8bit mt-1 w-full px-3 py-2"
                      value={week.declaredGrandTotal}
                      onChange={(e) => {
                        const value = Number(e.target.value);
                        setWeeks((prev) =>
                          prev.map((w, i) =>
                            i === selectedIndex ? { ...w, declaredGrandTotal: Number.isFinite(value) ? value : 0 } : w
                          )
                        );
                      }}
                    />
                  </label>

                  <label className="block">
                    <span className="helper-8bit">Season (e.g. 2024)</span>
                    <input
                      type="number"
                      className="input-8bit mt-1 w-full px-3 py-2"
                      value={week.season}
                      onChange={(e) => {
                        const value = Number(e.target.value);
                        setWeeks((prev) =>
                          prev.map((w, i) =>
                            i === selectedIndex ? { ...w, season: Number.isFinite(value) ? value : w.season } : w
                          )
                        );
                      }}
                    />
                  </label>

                  <div className="grid grid-cols-2 gap-3">
                    <label className="block">
                      <span className="helper-8bit">NFL Week #</span>
                      <input
                        type="number"
                        className="input-8bit mt-1 w-full px-3 py-2"
                        value={week.weekNumber}
                        onChange={(e) => {
                          const value = Number(e.target.value);
                          setWeeks((prev) =>
                            prev.map((w, i) =>
                              i === selectedIndex ? { ...w, weekNumber: Number.isFinite(value) ? value : w.weekNumber } : w
                            )
                          );
                        }}
                      />
                    </label>
                    <label className="block">
                      <span className="helper-8bit">Season Phase</span>
                      <select
                        className="select-8bit mt-1 w-full px-3 py-2"
                        value={week.seasonType}
                        onChange={(e) => {
                          const value = Number(e.target.value);
                          setWeeks((prev) =>
                            prev.map((w, i) =>
                              i === selectedIndex ? { ...w, seasonType: Number.isFinite(value) ? value : w.seasonType } : w
                            )
                          );
                        }}
                      >
                        {SEASON_TYPES.map((opt) => (
                          <option key={opt.value} value={opt.value}>
                            {opt.label}
                          </option>
                        ))}
                      </select>
                    </label>
                  </div>

                  <div className="panel-8bit p-3 space-y-3">
                    <div className="flex flex-wrap items-center gap-2">
                      <button
                        onClick={() => fetchScores()}
                        disabled={syncing}
                        className={`btn-8bit warn inline-flex items-center gap-2 px-3 py-2 text-sm disabled:opacity-60`}
                      >
                        {syncing ? "Syncingâ€¦" : "Sync Live Scores"}
                      </button>
                      <label className="inline-flex items-center gap-2 text-xs">
                        <input
                          type="checkbox"
                          className="accent-[var(--tecmo-gold)]"
                          checked={autoRefresh}
                          onChange={(e) => setAutoRefresh(e.target.checked)}
                        />
                        <span className="helper-8bit">Auto refresh every 60s</span>
                      </label>
                    </div>
                    <div className="helper-8bit">
                      Source: ESPN public scoreboard API. Last sync:{" "}
                      {week.lastFetchedUtc ? new Date(week.lastFetchedUtc).toLocaleString() : "never"}
                    </div>
                    {(week.lastWarnings || []).length > 0 && (
                      <div className="panel-8bit bg-[rgba(248,184,0,0.12)] px-3 py-2 text-[11px]">
                        <div className="pixel-font text-[11px]">Teams needing manual review</div>
                        <ul className="mt-1 space-y-1">
                          {week.lastWarnings.map((w, i) => (
                            <li key={i}>â€¢ {w}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>

                  <label className="block">
                    <span className="helper-8bit">Pre-Out (label:count, one per line)</span>
                    <textarea
                      className="textarea-8bit mt-1 w-full min-h-[80px] px-3 py-2"
                      defaultValue={(week.preOut || []).map((p) => `${p.label}:${p.count}`).join("\n")}
                      onBlur={(e) => {
                        const preOut = e.target.value
                          .split(/\r?\n/)
                          .map((l) => l.trim())
                          .filter(Boolean)
                          .map((l) => {
                            const [label, countRaw] = l.split(":");
                            return {
                              label: (label || "Pre-Out").trim(),
                              count: Number.isFinite(Number(countRaw)) ? Number(countRaw) : 0,
                            };
                          });
                        setWeeks((prev) =>
                          prev.map((w, i) => (i === selectedIndex ? { ...w, preOut } : w))
                        );
                      }}
                    ></textarea>
                  </label>
                </div>
              </div>

              <div className="panel-8bit p-5 rounded-md">
                <h3 className="pixel-font text-sm uppercase">Quick How-To</h3>
                <ol className="mt-2 space-y-2 text-sm list-decimal list-inside">
                  <li>Pick a week above (add the next week when ready).</li>
                  <li>Paste your picks (Team,Count per line) or edit inline.</li>
                  <li>Hit <span className="pixel-font">Sync Live Scores</span> to pull ESPN results.</li>
                  <li>Manual overrides still work â€” ties count as losses when syncing.</li>
                  <li>Export/Import JSON for off-line backups between weeks.</li>
                </ol>
              </div>
            </div>
          </div>

          <div className="mt-10 text-center text-xs text-tecmo-white/70">
            Built for your LMS pool â€¢ Powered by ESPN live scores â€¢ Tecmo skin
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>]
